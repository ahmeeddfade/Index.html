<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ElAhmad TV</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
/* ================= BASE ================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  width: 100%;
  height: 100%;
  background: #000;
  overflow: hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color: #fff;
}

video {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: #000;
  z-index: 1;
}

/* ================= SPLASH ================= */
#splash {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  transition: .6s;
}

#splash.hide {
  opacity: 0;
  pointer-events: none;
}

#splash h1 {
  font-size: 3rem;
  background: linear-gradient(90deg, #ff6f00, #ffbb00);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* ================= OVERLAY ================= */
#overlay {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 8px 22px;
  background: linear-gradient(to top, rgba(0,0,0,.9), transparent);
  display: flex;
  justify-content: center;
  transition: .25s;
  z-index: 5;
}

#overlay.hide {
  opacity: 0;
  transform: translateY(20px);
  pointer-events: none;
}

/* ================= CHANNEL LIST ================= */
#channels {
  display: flex;
  gap: 12px;
  max-width: 95%;
  overflow-x: auto;
  direction: ltr;
  scrollbar-width: none;
}

#channels::-webkit-scrollbar {
  display: none;
}

/* ================= CARD ================= */
.channel {
  width: 180px;
  padding: 8px;
  border-radius: 16px;
  background: rgba(255, 255, 255, .07);
  text-align: center;
  cursor: pointer;
  transition: .25s;
  flex-shrink: 0;
}

.channel img {
  width: 100%;
  height: 62px;
  object-fit: contain;
}

.channel span {
  display: block;
  margin-top: 4px;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.channel.active {
  background: linear-gradient(135deg, #ff6f00, #ff8f00);
  transform: scale(1.15);
  box-shadow: 0 10px 30px rgba(255, 111, 0, .4);
}

/* ================= HINT ================= */
#hint {
  position: fixed;
  top: 20px;
  left: 24px;
  background: rgba(0, 0, 0, .6);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 14px;
  opacity: 0;
  transition: .3s;
  z-index: 6;
  backdrop-filter: blur(10px);
}

#hint.show {
  opacity: .7;
}

/* ================= LOADING INDICATOR ================= */
#loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 50px;
  height: 50px;
  border: 5px solid rgba(255, 255, 255, .3);
  border-radius: 50%;
  border-top-color: #ff6f00;
  animation: spin 1s ease-in-out infinite;
  z-index: 100;
  display: none;
}

@keyframes spin {
  to {
    transform: translate(-50%, -50%) rotate(360deg);
  }
}

/* ================= ERROR MESSAGE ================= */
#error {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, .8);
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  max-width: 80%;
  display: none;
  z-index: 99;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 0, 0, .3);
}

#error h3 {
  color: #ff6f00;
  margin-bottom: 10px;
}

#error button {
  margin-top: 15px;
  padding: 8px 20px;
  background: #ff6f00;
  border: none;
  border-radius: 20px;
  color: white;
  cursor: pointer;
}

/* ================= AUDIO CONTROL ================= */
#audioControl {
  position: fixed;
  bottom: 90px;
  left: 24px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(0, 0, 0, .7);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 7;
  transition: .2s;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, .1);
}

#audioControl:hover {
  background: rgba(0, 0, 0, .9);
  transform: scale(1.1);
}

#audioControl.muted {
  background: rgba(255, 0, 0, .2);
}

#audioControl span {
  font-size: 20px;
}

/* ================= RESPONSIVE ================= */
@media (max-width: 768px) {
  .channel {
    width: 150px;
  }
  
  #channels {
    max-width: 100%;
    padding: 0 10px;
  }
  
  #hint {
    font-size: 12px;
    padding: 4px 10px;
    left: 10px;
  }
  
  #audioControl {
    bottom: 80px;
    left: 10px;
    width: 40px;
    height: 40px;
  }
}

@media (max-width: 480px) {
  .channel {
    width: 130px;
  }
  
  .channel img {
    height: 50px;
  }
  
  #splash h1 {
    font-size: 2.2rem;
  }
}

/* ================= KEYBOARD SHORTCUTS INFO ================= */
#shortcuts {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, .95);
  padding: 25px;
  border-radius: 15px;
  max-width: 90%;
  width: 400px;
  display: none;
  z-index: 110;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 111, 0, .3);
}

#shortcuts h3 {
  color: #ff6f00;
  margin-bottom: 20px;
  text-align: center;
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, .1);
}

.shortcut-key {
  background: rgba(255, 111, 0, .2);
  padding: 2px 8px;
  border-radius: 4px;
  font-family: monospace;
}
</style>
</head>

<body>

<div id="splash"><h1>ElAhmad TV</h1></div>
<video id="player" autoplay playsinline></video>

<div id="loading"></div>

<div id="error">
  <h3>âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
  <p id="errorMessage"></p>
  <button onclick="retryCurrentChannel()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
</div>

<div id="hint">â¬…ï¸â¡ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø© | â¬†ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© | Ù…Ø³Ø§ÙØ©: ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù | ESC: Ø®Ø±ÙˆØ¬</div>

<div id="audioControl" title="ÙƒØªÙ…/Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙˆØª">
  <span>ğŸ”Š</span>
</div>

<div id="shortcuts">
  <h3>Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</h3>
  <div class="shortcut-item">
    <span>â¡ï¸</span>
    <span class="shortcut-key">Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£ÙŠÙ…Ù†</span>
    <span>Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</span>
  </div>
  <div class="shortcut-item">
    <span>â¬…ï¸</span>
    <span class="shortcut-key">Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£ÙŠØ³Ø±</span>
    <span>Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</span>
  </div>
  <div class="shortcut-item">
    <span>â¬†ï¸</span>
    <span class="shortcut-key">Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ</span>
    <span>Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
  </div>
  <div class="shortcut-item">
    <span>â£</span>
    <span class="shortcut-key">Ø§Ù„Ù…Ø³Ø§ÙØ©</span>
    <span>ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</span>
  </div>
  <div class="shortcut-item">
    <span>ESC</span>
    <span class="shortcut-key">Escape</span>
    <span>Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ø±ØªÙŠÙ†)</span>
  </div>
  <div class="shortcut-item">
    <span>ØŸ</span>
    <span class="shortcut-key">Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø§Ø³ØªÙÙ‡Ø§Ù…</span>
    <span>Ø¥Ø¸Ù‡Ø§Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
  </div>
  <div style="text-align:center;margin-top:20px;">
    <button onclick="toggleShortcuts()" style="padding:8px 25px;">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<div id="overlay">
  <div id="channels" role="list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª"></div>
</div>

<script>
/* ================= CONFIG ================= */
const CHANNELS_URL = "channels.json";
const STORAGE_KEY = "elahmad_last_channel";
const CACHE_KEY = "elahmad_cache";
const CACHE_DURATION = 3600000; // 1 Ø³Ø§Ø¹Ø©

/* ================= STATE ================= */
const state = {
  index: 0,
  channels: [],
  overlayVisible: true,
  exitArmed: false,
  isMuted: false,
  isLoading: false,
  imageCache: new Map(),
  isTouchDevice: 'ontouchstart' in window
};

/* ================= ELEMENTS ================= */
const video = document.getElementById("player");
const splash = document.getElementById("splash");
const overlay = document.getElementById("overlay");
const list = document.getElementById("channels");
const hint = document.getElementById("hint");
const loading = document.getElementById("loading");
const errorDiv = document.getElementById("error");
const errorMessage = document.getElementById("errorMessage");
const audioControl = document.getElementById("audioControl");
const shortcuts = document.getElementById("shortcuts");

/* ================= HLS INSTANCE ================= */
let hls = null;
let retryCount = 0;
const MAX_RETRIES = 3;

/* ================= IMAGE CACHE ================= */
function loadImage(url) {
  if (state.imageCache.has(url)) {
    return Promise.resolve(state.imageCache.get(url));
  }
  
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      state.imageCache.set(url, img);
      resolve(img);
    };
    img.onerror = reject;
    img.src = url;
    img.loading = "lazy";
  });
}

/* ================= ERROR HANDLING ================= */
function showError(message) {
  errorMessage.textContent = message;
  errorDiv.style.display = "block";
  hideLoading();
}

function hideError() {
  errorDiv.style.display = "none";
}

function showLoading() {
  if (!state.isLoading) {
    state.isLoading = true;
    loading.style.display = "block";
  }
}

function hideLoading() {
  state.isLoading = false;
  loading.style.display = "none";
}

/* ================= PLAYER FUNCTIONS ================= */
async function playChannel(ch) {
  if (state.isLoading) return;
  
  hideError();
  showLoading();
  retryCount = 0;
  
  try {
    if (hls) {
      hls.destroy();
      hls = null;
    }
    
    if (Hls.isSupported()) {
      hls = new Hls({
        lowLatencyMode: true,
        maxBufferLength: 30,
        backBufferLength: 60,
        enableWorker: true,
        autoStartLoad: true
      });
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ HLS
      hls.on(Hls.Events.ERROR, (event, data) => {
        if (data.fatal) {
          switch (data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              console.error("Network Error:", data);
              if (retryCount < MAX_RETRIES) {
                retryCount++;
                setTimeout(() => playChannel(ch), 1000 * retryCount);
              } else {
                showError("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø«. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
              }
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              console.error("Media Error:", data);
              hls.recoverMediaError();
              break;
            default:
              hls.destroy();
              showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
              break;
          }
        }
      });
      
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        hideLoading();
      });
      
      hls.loadSource(ch.stream);
      hls.attachMedia(video);
    } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
      // Ø¯Ø¹Ù… Safari
      video.src = ch.stream;
      hideLoading();
    } else {
      showError("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø¨Ø«");
      return;
    }
    
    video.play().catch(err => {
      console.error("Playback error:", err);
      if (err.name === "NotAllowedError") {
        showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­");
      }
    });
    
    localStorage.setItem(STORAGE_KEY, state.index);
    hideSplash();
  } catch (error) {
    console.error("Channel play error:", error);
    showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©");
    hideLoading();
  }
}

function retryCurrentChannel() {
  hideError();
  if (state.channels[state.index]) {
    playChannel(state.channels[state.index]);
  }
}

/* ================= UI FUNCTIONS ================= */
function createChannelElement(channel, index) {
  const el = document.createElement("div");
  el.className = "channel";
  el.role = "listitem";
  el.tabIndex = 0;
  el.setAttribute("aria-label", `Ù‚Ù†Ø§Ø© ${channel.name}`);
  
  const img = document.createElement("img");
  img.alt = channel.name;
  img.loading = "lazy";
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ÙƒØ§Ø´
  loadImage(channel.logo).then(cachedImg => {
    img.src = cachedImg.src;
  }).catch(() => {
    img.src = channel.logo;
  });
  
  const span = document.createElement("span");
  span.textContent = channel.name;
  
  el.appendChild(img);
  el.appendChild(span);
  
  el.onclick = () => select(index);
  el.onkeydown = (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      select(index);
    }
  };
  
  return el;
}

function render() {
  const children = [...list.children];
  children.forEach((el, i) => {
    el.classList.toggle("active", i === state.index);
    el.setAttribute("aria-selected", i === state.index);
  });
  
  const activeElement = list.children[state.index];
  if (activeElement) {
    activeElement.scrollIntoView({
      behavior: "smooth",
      inline: "center",
      block: "nearest"
    });
  }
}

function showOverlay() {
  overlay.classList.remove("hide");
  hint.classList.add("show");
  clearTimeout(showOverlay.timer);
  showOverlay.timer = setTimeout(() => {
    if (!state.isTouchDevice) {
      overlay.classList.add("hide");
      hint.classList.remove("show");
    }
  }, 4000);
}

function hideOverlay() {
  overlay.classList.add("hide");
  hint.classList.remove("show");
}

function toggleOverlay() {
  if (overlay.classList.contains("hide")) {
    showOverlay();
  } else {
    hideOverlay();
  }
}

/* ================= AUDIO CONTROL ================= */
function toggleMute() {
  state.isMuted = !state.isMuted;
  video.muted = state.isMuted;
  audioControl.classList.toggle("muted", state.isMuted);
  audioControl.innerHTML = state.isMuted ? "<span>ğŸ”‡</span>" : "<span>ğŸ”Š</span>";
  audioControl.title = state.isMuted ? "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙˆØª" : "ÙƒØªÙ… Ø§Ù„ØµÙˆØª";
  
  // Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¤Ù‚Øª
  hint.textContent = state.isMuted ? "ğŸ”‡ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ…" : "ğŸ”Š Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„";
  hint.classList.add("show");
  setTimeout(() => {
    hint.textContent = "â¬…ï¸â¡ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø© | â¬†ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© | Ù…Ø³Ø§ÙØ©: ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù | ESC: Ø®Ø±ÙˆØ¬";
  }, 2000);
}

/* ================= SPLASH ================= */
function hideSplash() {
  if (!hideSplash.done) {
    hideSplash.done = true;
    setTimeout(() => splash.classList.add("hide"), 2000);
  }
}

/* ================= NAVIGATION ================= */
function select(index) {
  const newIndex = (index + state.channels.length) % state.channels.length;
  if (newIndex === state.index) return;
  
  state.index = newIndex;
  render();
  playChannel(state.channels[state.index]);
  showOverlay();
}

/* ================= SHORTCUTS HELP ================= */
function toggleShortcuts() {
  shortcuts.style.display = shortcuts.style.display === "block" ? "none" : "block";
}

/* ================= KEYBOARD SHORTCUTS ================= */
const KEY_ACTIONS = {
  'ArrowRight': () => select(state.index + 1),
  'ArrowLeft': () => select(state.index - 1),
  'ArrowUp': () => toggleOverlay(),
  ' ': () => {
    if (video.paused) {
      video.play();
      hint.textContent = "â–¶ï¸ Ø§Ù„ØªØ´ØºÙŠÙ„";
    } else {
      video.pause();
      hint.textContent = "â¸ï¸ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª";
    }
    hint.classList.add("show");
    setTimeout(() => {
      hint.textContent = "â¬…ï¸â¡ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø© | â¬†ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© | Ù…Ø³Ø§ÙØ©: ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù | ESC: Ø®Ø±ÙˆØ¬";
    }, 2000);
  },
  'm': () => toggleMute(),
  '?': () => toggleShortcuts()
};

document.addEventListener("keydown", e => {
  if (!state.channels.length) return;
  
  if (KEY_ACTIONS[e.key]) {
    e.preventDefault();
    KEY_ACTIONS[e.key]();
    showOverlay();
    return;
  }
  
  if (e.key === "Backspace" || e.key === "Escape") {
    e.preventDefault();
    if (shortcuts.style.display === "block") {
      toggleShortcuts();
      return;
    }
    
    if (state.exitArmed) {
      if (hls) hls.destroy();
      window.close();
    } else {
      state.exitArmed = true;
      hint.textContent = "âš ï¸ Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø®Ø±ÙˆØ¬";
      hint.classList.add("show");
      setTimeout(() => {
        state.exitArmed = false;
        hint.textContent = "â¬…ï¸â¡ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø© | â¬†ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© | Ù…Ø³Ø§ÙØ©: ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù | ESC: Ø®Ø±ÙˆØ¬";
      }, 2000);
    }
  }
});

/* ================= TOUCH CONTROLS ================= */
let touchStartX = 0;
let touchStartY = 0;
let touchStartTime = 0;

document.addEventListener("touchstart", e => {
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  touchStartTime = Date.now();
  showOverlay();
});

document.addEventListener("touchend", e => {
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  const dt = Date.now() - touchStartTime;
  
  // Swipe horizontal Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø©
  if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) && dt < 300) {
    select(dx < 0 ? state.index + 1 : state.index - 1);
  }
  
  // Tap ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  if (Math.abs(dx) < 20 && Math.abs(dy) < 20 && dt < 200) {
    const tapY = e.changedTouches[0].clientY;
    if (tapY < 100) { // Tap ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
      toggleOverlay();
    }
  }
});

/* ================= MOUSE CONTROLS ================= */
document.addEventListener("mousemove", () => {
  if (!state.isTouchDevice) {
    showOverlay();
  }
});

/* ================= LOAD CHANNELS ================= */
async function loadChannels() {
  try {
    showLoading();
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´ Ø£ÙˆÙ„Ø§Ù‹
    const cached = localStorage.getItem(CACHE_KEY);
    const cacheTime = localStorage.getItem(`${CACHE_KEY}_time`);
    
    if (cached && cacheTime && (Date.now() - cacheTime < CACHE_DURATION)) {
      const data = JSON.parse(cached);
      processChannelsData(data);
    } else {
      const response = await fetch(CHANNELS_URL);
      if (!response.ok) throw new Error("Failed to fetch channels");
      
      const data = await response.json();
      
      // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      localStorage.setItem(`${CACHE_KEY}_time`, Date.now());
      
      processChannelsData(data);
    }
  } catch (error) {
    console.error("Error loading channels:", error);
    showError("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
    hideLoading();
  }
}

function processChannelsData(data) {
  state.channels = data.channels || [];
  
  if (state.channels.length === 0) {
    showError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");
    return;
  }
  
  const saved = +localStorage.getItem(STORAGE_KEY);
  if (saved >= 0 && saved < state.channels.length) {
    state.index = saved;
  }
  
  // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  list.innerHTML = "";
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©
  const preloadCount = Math.min(3, state.channels.length);
  const start = Math.max(0, state.index - 1);
  const end = Math.min(state.channels.length, state.index + preloadCount);
  
  for (let i = start; i < end; i++) {
    if (i !== state.index) {
      loadImage(state.channels[i].logo).catch(() => {});
    }
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ù†ÙˆØ§Øª
  state.channels.forEach((channel, i) => {
    const el = createChannelElement(channel, i);
    list.appendChild(el);
  });
  
  // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  render();
  playChannel(state.channels[state.index]);
  hideLoading();
}

/* ================= SERVICE WORKER REGISTRATION ================= */
if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(error => {
      console.log('ServiceWorker registration failed:', error);
    });
  });
}

/* ================= AUDIO CONTROL EVENT ================= */
audioControl.addEventListener("click", toggleMute);

/* ================= INITIALIZATION ================= */
window.addEventListener("load", () => {
  loadChannels();
  
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø¨Ø¹Ø¯ ÙˆÙ‚Øª Ø£Ø·ÙˆÙ„
  if (state.isTouchDevice) {
    setTimeout(() => {
      hint.classList.remove("show");
    }, 5000);
  }
});

/* ================= CLEANUP ON EXIT ================= */
window.addEventListener("beforeunload", () => {
  if (hls) {
    hls.destroy();
  }
});

/* ================= OFFLINE DETECTION ================= */
window.addEventListener("offline", () => {
  showError("Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
});

window.addEventListener("online", () => {
  hideError();
});

/* ================= FULLSCREEN SUPPORT ================= */
document.addEventListener("dblclick", () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(() => {});
  } else {
    document.exitFullscreen();
  }
});

/* ================= CONTEXT MENU PREVENTION ================= */
document.addEventListener("contextmenu", (e) => {
  if (e.target.tagName === "VIDEO") {
    e.preventDefault();
  }
});
</script>

</body>
</html>
