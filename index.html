<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ElAhmad TV</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:system-ui;color:#fff}
video{position:fixed;inset:0;width:100%;height:100%;object-fit:contain;background:#000;z-index:1}

#splash{position:fixed;inset:0;background:#0a0a0a;display:flex;align-items:center;justify-content:center;z-index:10;transition:.6s}
#splash.hide{opacity:0;pointer-events:none}
#splash h1{font-size:3rem;background:linear-gradient(90deg,#ff6f00,#ffbb00);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

#overlay{position:fixed;bottom:0;left:0;width:100%;padding:8px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);z-index:5;transition:.25s}
#overlay.hide{opacity:0;transform:translateY(20px);pointer-events:none}

#channels{display:flex;gap:10px;max-width:100%;overflow-x:auto;direction:ltr;padding:0 10px;scrollbar-width:none}
#channels::-webkit-scrollbar{display:none}

.channel{width:140px;padding:6px;border-radius:12px;background:rgba(255,255,255,.07);text-align:center;cursor:pointer;transition:.2s;flex-shrink:0}
.channel img{width:100%;height:60px;object-fit:contain}
.channel span{display:block;margin-top:4px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.channel.active{background:linear-gradient(135deg,#ff6f00,#ff8f00);transform:scale(1.1);box-shadow:0 8px 20px rgba(255,111,0,.4)}

#hint{position:fixed;top:15px;left:15px;background:rgba(0,0,0,.6);padding:5px 12px;border-radius:15px;font-size:13px;opacity:0;transition:.3s;z-index:6}
#hint.show{opacity:.7}

#loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:4px solid rgba(255,255,255,.2);border-radius:50%;border-top-color:#ff6f00;animation:spin 1s linear infinite;z-index:100;display:none}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

@media (max-width:768px){.channel{width:120px}.channel img{height:50px}}
</style>
</head>

<body>

<div id="splash"><h1>ElAhmad TV</h1></div>
<video id="player" autoplay playsinline></video>
<div id="loading"></div>
<div id="hint">⬅️➡️ تغيير القناة | ⬆️ إظهار القائمة | ESC للخروج</div>
<div id="overlay"><div id="channels"></div></div>

<script>
// ================= تهيئة =================
const CHANNELS_URL = "channels.json";
const STORAGE_KEY = "elahmad_last_channel";
const state = { index: 0, channels: [], overlayVisible: true };
const video = document.getElementById("player");
const splash = document.getElementById("splash");
const overlay = document.getElementById("overlay");
const list = document.getElementById("channels");
const hint = document.getElementById("hint");
const loading = document.getElementById("loading");
let hls = null;

// ================= تشغيل القناة =================
function playChannel(ch) {
  if (hls) { hls.destroy(); hls = null; }
  
  loading.style.display = "block";
  
  if (Hls.isSupported()) {
    hls = new Hls({ 
      lowLatencyMode: true,
      maxBufferLength: 15,
      backBufferLength: 30
    });
    
    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        console.error('خطأ في البث:', data);
      }
    });
    
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      loading.style.display = "none";
    });
    
    hls.loadSource(ch.stream);
    hls.attachMedia(video);
  } else {
    video.src = ch.stream;
    loading.style.display = "none";
  }
  
  video.play().catch(() => {});
  localStorage.setItem(STORAGE_KEY, state.index);
  hideSplash();
}

// ================= واجهة المستخدم =================
function render() {
  document.querySelectorAll('.channel').forEach((el, i) => {
    el.classList.toggle('active', i === state.index);
  });
  
  const activeEl = list.children[state.index];
  if (activeEl) {
    activeEl.scrollIntoView({ behavior: 'smooth', inline: 'center' });
  }
}

function showOverlay() {
  overlay.classList.remove('hide');
  hint.classList.add('show');
  clearTimeout(showOverlay.timer);
  showOverlay.timer = setTimeout(() => {
    if (!'ontouchstart' in window) {
      overlay.classList.add('hide');
      hint.classList.remove('show');
    }
  }, 3000);
}

function hideSplash() {
  if (!hideSplash.done) {
    hideSplash.done = true;
    setTimeout(() => splash.classList.add('hide'), 2000);
  }
}

function select(index) {
  state.index = (index + state.channels.length) % state.channels.length;
  render();
  playChannel(state.channels[state.index]);
  showOverlay();
}

// ================= إدخال المستخدم =================
document.addEventListener('keydown', e => {
  if (!state.channels.length) return;
  
  if (e.key === 'ArrowRight') select(state.index + 1);
  if (e.key === 'ArrowLeft') select(state.index - 1);
  if (e.key === 'ArrowUp') showOverlay();
  if (e.key === ' ') video.paused ? video.play() : video.pause();
  if (e.key === 'Escape') window.close();
});

let touchStartX = 0;
document.addEventListener('touchstart', e => {
  touchStartX = e.touches[0].clientX;
  showOverlay();
});

document.addEventListener('touchend', e => {
  const dx = e.changedTouches[0].clientX - touchStartX;
  if (Math.abs(dx) > 50) {
    select(dx < 0 ? state.index + 1 : state.index - 1);
  }
});

document.addEventListener('mousemove', showOverlay);

// ================= تحميل القنوات =================
fetch(CHANNELS_URL)
  .then(r => r.json())
  .then(data => {
    state.channels = data.channels || [];
    const saved = +localStorage.getItem(STORAGE_KEY);
    if (saved >= 0 && saved < state.channels.length) state.index = saved;
    
    // حل مشكلة الصورة: إعادة تحميل الصور عند كل قناة
    state.channels.forEach((ch, i) => {
      const el = document.createElement('div');
      el.className = 'channel';
      
      // إنشاء صورة جديدة لكل قناة (بدون كاش)
      const img = new Image();
      img.src = ch.logo;
      img.alt = ch.name;
      
      const span = document.createElement('span');
      span.textContent = ch.name;
      
      el.appendChild(img);
      el.appendChild(span);
      el.onclick = () => select(i);
      list.appendChild(el);
    });
    
    select(state.index);
  })
  .catch(error => {
    console.error('فشل تحميل القنوات:', error);
    hint.textContent = '❌ فشل تحميل القنوات';
    hint.classList.add('show');
  });

// ================= حل نهائي لمشكلة الصور =================
// إعادة تحميل الصورة عند التبديل بين القنوات
function reloadImageForChannel(index) {
  const channelEl = list.children[index];
  if (channelEl) {
    const img = channelEl.querySelector('img');
    if (img) {
      // إعادة تحميل الصورة بمعرف فريد لمنع الكاش
      img.src = state.channels[index].logo + '?t=' + Date.now();
    }
  }
}

// استدعاء الدالة عند تغيير القناة
const originalSelect = select;
select = function(index) {
  reloadImageForChannel(state.index); // تحديث الصورة القديمة
  originalSelect(index);
  reloadImageForChannel(index); // تحميل الصورة الجديدة
};
</script>

</body>
</html>
