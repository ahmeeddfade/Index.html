<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ElAhmad TV</title>

<!-- hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#000;
  font-family:Arial, sans-serif;
  direction:rtl;
  color:#fff;
}

/* Header */
.header{
  background:#c62828;
  padding:14px;
  font-size:18px;
  font-weight:bold;
  text-align:center;
}

/* Player */
.player-wrap{
  position:relative;
  background:#000;
}
video{
  width:100%;
  max-height:55vh;
  background:#000;
  transition:opacity .25s ease;
}
video.loading{
  opacity:.4;
}

/* Loader */
.loader{
  display:none;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:#ff7043;
  font-size:15px;
  background:rgba(0,0,0,.6);
  padding:8px 14px;
  border-radius:20px;
}

/* Status */
.status{
  padding:10px;
  font-size:14px;
  color:#ccc;
  background:#111;
}

/* Channels Grid */
.channels{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  padding:10px;
}

/* Channel Card */
.card{
  background:#111;
  border-radius:12px;
  overflow:hidden;
  cursor:pointer;
  text-align:center;
  transition:.25s ease;
}

.card:hover{
  background:#1a1a1a;
}

/* Eye-comfort active frame */
.card.active{
  box-shadow:
    0 0 0 2px #ff7043,
    0 0 25px rgba(255,112,67,.35);
  background:#1b1b1b;
}

.card img{
  width:100%;
  height:90px;
  object-fit:contain;
  background:#000;
  filter:brightness(.9);
}
.card:hover img{
  filter:brightness(1);
}

.card span{
  display:block;
  padding:8px;
  font-size:14px;
}
</style>
</head>

<body>

<div class="header">ElAhmad TV</div>

<div class="player-wrap">
  <video id="player" controls playsinline></video>
  <div class="loader" id="loader">جاري التحميل...</div>
</div>

<div class="status" id="status">جاري تحميل القنوات...</div>
<div class="channels" id="channels"></div>

<script>
/* ملف القنوات */
const CHANNELS_URL = "channels.json";

const video   = document.getElementById("player");
const list    = document.getElementById("channels");
const statusE = document.getElementById("status");
const loader  = document.getElementById("loader");

let hls = null;

/* تشغيل البث – احترافي */
function playStream(url){
  statusE.textContent = "جاري فتح القناة...";
  loader.style.display="block";
  video.classList.add("loading");

  localStorage.setItem("lastChannel", url);

  if(hls){
    hls.destroy();
    hls = null;
  }

  if(Hls.isSupported()){
    hls = new Hls({
      lowLatencyMode:true,
      backBufferLength:90
    });

    hls.loadSource(url);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
      video.play();
    });

    hls.on(Hls.Events.ERROR,(e,data)=>{
      if(data.fatal){
        statusE.textContent = "⚠️ البث غير متاح حالياً";
        loader.style.display="none";
      }
    });

  }else if(video.canPlayType("application/vnd.apple.mpegurl")){
    video.src = url;
    video.play();
  }else{
    statusE.textContent = "المتصفح لا يدعم البث";
    loader.style.display="none";
  }
}

/* تحميل القنوات */
fetch(CHANNELS_URL)
.then(res=>res.json())
.then(data=>{
  if(!data.channels || data.channels.length===0){
    statusE.textContent = "لا توجد قنوات";
    return;
  }

  statusE.textContent = "اختر قناة للتشغيل";

  const lastChannel = localStorage.getItem("lastChannel");

  data.channels.forEach((ch,index)=>{
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.src = ch.logo || "https://via.placeholder.com/300x150?text=TV";

    const name = document.createElement("span");
    name.textContent = ch.name;

    card.appendChild(img);
    card.appendChild(name);

    card.onclick = ()=>{
      document.querySelectorAll(".card")
        .forEach(c=>c.classList.remove("active"));

      card.classList.add("active");
      playStream(ch.stream);
    };

    list.appendChild(card);

    /* تشغيل تلقائي */
    if(
      (lastChannel && ch.stream === lastChannel) ||
      (!lastChannel && index === 0)
    ){
      setTimeout(()=>{
        card.classList.add("active");
        playStream(ch.stream);
      },300);
    }
  });
})
.catch(()=>{
  statusE.textContent = "خطأ في تحميل ملف القنوات";
});

/* أحداث المشغل */
video.addEventListener("playing", ()=>{
  loader.style.display="none";
  video.classList.remove("loading");
  statusE.textContent = "يعمل الآن ✔";
});

video.addEventListener("error", ()=>{
  loader.style.display="none";
  statusE.textContent = "خطأ في البث";
});
</script>

</body>
</html>
