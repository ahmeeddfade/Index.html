<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ElAhmad TV</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
/* ================= BASE ================= */
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  width:100%;height:100%;
  background:#000;overflow:hidden;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff
}
video{
  position:fixed;inset:0;
  width:100%;height:100%;
  object-fit:contain;
  background:#000;
  z-index:1
}

/* ================= SPLASH ================= */
#splash{
  position:fixed;inset:0;
  background:linear-gradient(135deg,#0a0a0a,#1a1a2e);
  display:flex;align-items:center;justify-content:center;
  z-index:10;
  transition:.6s
}
#splash.hide{opacity:0;pointer-events:none}
#splash h1{
  font-size:3rem;
  background:linear-gradient(90deg,#ff6f00,#ffbb00);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent
}

/* ================= OVERLAY ================= */
#overlay{
  position:fixed;
  bottom:0;left:0;width:100%;
  padding:8px 22px;
  background:linear-gradient(to top,rgba(0,0,0,.9),transparent);
  display:flex;justify-content:center;
  transition:.25s;
  z-index:5
}
#overlay.hide{opacity:0;transform:translateY(20px);pointer-events:none}

/* ================= CHANNEL LIST ================= */
#channels{
  display:flex;
  gap:12px;
  max-width:95%;
  overflow-x:auto;
  direction:ltr;
  scrollbar-width:none
}
#channels::-webkit-scrollbar{display:none}

/* ================= CARD ================= */
.channel{
  width:180px;
  padding:8px;
  border-radius:16px;
  background:rgba(255,255,255,.07);
  text-align:center;
  cursor:pointer;
  transition:.25s;
  flex-shrink:0
}
.channel img{
  width:100%;
  height:62px;
  object-fit:contain
}
.channel span{
  display:block;
  margin-top:4px;
  font-size:14px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis
}
.channel.active{
  background:linear-gradient(135deg,#ff6f00,#ff8f00);
  transform:scale(1.15);
  box-shadow:0 10px 30px rgba(255,111,0,.4)
}

/* ================= HINT ================= */
#hint{
  position:fixed;
  top:20px;left:24px;
  background:rgba(0,0,0,.6);
  padding:6px 14px;
  border-radius:20px;
  font-size:14px;
  opacity:0;
  transition:.3s;
  z-index:6
}
#hint.show{opacity:.7}
</style>
</head>

<body>

<div id="splash"><h1>ElAhmad TV</h1></div>
<video id="player" autoplay playsinline></video>

<div id="hint">⬅️➡️ تغيير القناة | ⬆️ القائمة</div>

<div id="overlay">
  <div id="channels"></div>
</div>

<script>
/* ================= CONFIG ================= */
const CHANNELS_URL = "channels.json";
const STORAGE_KEY  = "elahmad_last_channel";

/* ================= STATE ================= */
const state = {
  index: 0,
  channels: [],
  overlayVisible: true,
  exitArmed: false
};

/* ================= ELEMENTS ================= */
const video   = document.getElementById("player");
const splash  = document.getElementById("splash");
const overlay = document.getElementById("overlay");
const list    = document.getElementById("channels");
const hint    = document.getElementById("hint");

/* ================= PLAYER ================= */
let hls = null;

function playChannel(ch){
  if(hls){hls.destroy();hls=null}
  if(Hls.isSupported()){
    hls = new Hls({
      lowLatencyMode:true,
      maxBufferLength:30,
      backBufferLength:60
    });
    hls.loadSource(ch.stream);
    hls.attachMedia(video);
  }else{
    video.src = ch.stream;
  }
  video.play().catch(()=>{});
  localStorage.setItem(STORAGE_KEY,state.index);
  hideSplash();
}

/* ================= UI ================= */
function render(){
  [...list.children].forEach((el,i)=>{
    el.classList.toggle("active", i===state.index);
  });
  list.children[state.index]?.scrollIntoView({
    behavior:"smooth",inline:"center"
  });
}

function showOverlay(){
  overlay.classList.remove("hide");
  hint.classList.add("show");
  clearTimeout(showOverlay.timer);
  showOverlay.timer = setTimeout(()=>{
    overlay.classList.add("hide");
    hint.classList.remove("show");
  },4000);
}

/* ================= SPLASH ================= */
function hideSplash(){
  if(!hideSplash.done){
    hideSplash.done = true;
    setTimeout(()=>splash.classList.add("hide"),3000);
  }
}

/* ================= NAVIGATION ================= */
function select(index){
  state.index = (index + state.channels.length) % state.channels.length;
  render();
  playChannel(state.channels[state.index]);
  showOverlay();
}

/* ================= INPUT ================= */
document.addEventListener("keydown",e=>{
  if(!state.channels.length)return;

  if(["ArrowRight","ArrowLeft","ArrowUp"].includes(e.key)){
    e.preventDefault();
    showOverlay();
  }

  if(e.key==="ArrowRight") select(state.index+1);
  if(e.key==="ArrowLeft")  select(state.index-1);

  if(e.key==="Backspace"||e.key==="Escape"){
    if(state.exitArmed){
      if(hls)hls.destroy();
      window.close();
    }else{
      state.exitArmed=true;
      hint.textContent="اضغط مرة أخرى للخروج";
      hint.classList.add("show");
      setTimeout(()=>{
        state.exitArmed=false;
        hint.textContent="⬅️➡️ تغيير القناة | ⬆️ القائمة";
      },2000);
    }
  }
});

/* Touch */
let startX=0;
document.addEventListener("touchstart",e=>{
  startX=e.touches[0].clientX;
  showOverlay();
});
document.addEventListener("touchend",e=>{
  const dx=e.changedTouches[0].clientX-startX;
  if(Math.abs(dx)>60){
    select(dx<0?state.index+1:state.index-1);
  }
});

/* Mouse */
document.addEventListener("mousemove",showOverlay);

/* ================= LOAD ================= */
fetch(CHANNELS_URL).then(r=>r.json()).then(d=>{
  state.channels = d.channels || [];
  const saved = +localStorage.getItem(STORAGE_KEY);
  if(saved>=0) state.index = saved;

  state.channels.forEach((c,i)=>{
    const el=document.createElement("div");
    el.className="channel";
    el.innerHTML=`<img src="${c.logo}"><span>${c.name}</span>`;
    el.onclick=()=>select(i);
    list.appendChild(el);
  });

  select(state.index);
});
</script>

</body>
</html>
